Metadata-Version: 2.4
Name: sp-lakehouse-backup
Version: 0.1.0
Summary: Multi-server PostgreSQL backup/restore orchestration using LangChain + LangGraph with Ollama LLMs and MCP REST APIs
Author: SP Lakehouse Backup Team
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: langchain>=0.3.0
Requires-Dist: langgraph>=0.2.0
Requires-Dist: langchain-ollama>=0.3.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: httpx>=0.28.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: rich>=13.0.0
Requires-Dist: typer>=0.12.0
Requires-Dist: python-dateutil>=2.9.0
Provides-Extra: dev
Requires-Dist: pytest>=8.0.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.24.0; extra == "dev"
Requires-Dist: black>=24.0.0; extra == "dev"
Requires-Dist: isort>=5.13.0; extra == "dev"
Requires-Dist: mypy>=1.8.0; extra == "dev"

# PostgreSQL Multi-Server Backup/Restore Orchestrator

A Python project that uses LangChain + LangGraph with Ollama LLMs to orchestrate PostgreSQL backup/restore operations across two Postgres servers, each fronted by its own MCP server that exposes backup/restore tools over REST.

## ğŸ¯ Features

- **Multi-Server Support**: Manages two PostgreSQL servers (PG1 and PG2) via separate MCP endpoints
- **AI-Powered Orchestration**: Uses Ollama LLMs with LangChain/LangGraph for intelligent request routing
- **Automatic Restore Planning**: Suggests optimal restore points based on timestamp proximity or latest available
- **No Local DB Operations**: All backup/restore operations go through MCP REST APIs only
- **Intelligent Routing**: Supervisor agent routes operations to appropriate backup agents
- **Interactive CLI**: Rich terminal interface with natural language command processing

## ğŸ—ï¸ Architecture

```
User â”€â”€> LangGraph Supervisor (Ollama)
         â”‚
         â”œâ”€(handoff)â”€> BackupAgentPG1 (LangChain+Ollama) â”€â”€> MCP1 (REST) â”€â”€> PG Server 1
         â””â”€(handoff)â”€> BackupAgentPG2 (LangChain+Ollama) â”€â”€> MCP2 (REST) â”€â”€> PG Server 2
```

- **Supervisor Agent**: Interprets user intent and routes to appropriate backup agents
- **Backup Agents**: Execute operations via MCP REST tools for their respective servers
- **MCP Servers**: Own backup scheduling (2-minute incremental + weekly full) and on-demand operations
- **No Direct DB Access**: All operations go through MCP REST APIs

## ğŸ“‹ Requirements

### Prerequisites

1. **Ollama**: Local LLM server
2. **MCP Servers**: Two running MCP servers exposing PostgreSQL backup/restore APIs
3. **Python 3.11+**: For running the orchestrator

### MCP Server API Requirements

Each MCP server must expose these REST endpoints:

```
GET  {MCP_BASE_URL}/tools â†’ JSON array of tool descriptors
POST {MCP_BASE_URL}/invoke â†’ Tool execution with JSON payload
```

Expected MCP tools:
- `list_tools`
- `trigger_full_backup`
- `trigger_incremental_backup` 
- `list_backups`
- `restore_database`
- `enable_schedules`
- `health`

## ğŸš€ Installation & Setup

### 1. Install and Setup Ollama

```bash
# Install Ollama (macOS)
brew install ollama

# Start Ollama service
ollama serve

# Pull the required model
ollama pull llama3.1:8b-instruct
```

### 2. Start MCP Servers

Start your two MCP servers (not part of this repo):

```bash
# Terminal 1: Start MCP1 server
cd /path/to/mcp1-server
python app.py --port 8001

# Terminal 2: Start MCP2 server  
cd /path/to/mcp2-server
python app.py --port 8002
```

### 3. Setup the Orchestrator

```bash
# Clone and enter the project
cd sp-lakehouse-backup

# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -e .

# Configure environment
cp env.example .env
```

### 4. Configure Environment Variables

Edit `.env` file:

```bash
# MCP servers
MCP1_BASE_URL=http://localhost:8001
MCP1_API_KEY=your-api-key-here
MCP2_BASE_URL=http://localhost:8002 
MCP2_API_KEY=your-api-key-here

# Ollama
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3.1:8b-instruct

# Optional LLM params
OLLAMA_TEMPERATURE=0.2
OLLAMA_NUM_CTX=8192
```

## ğŸ® Usage

### Start Interactive CLI

```bash
python -m cli run
```

### Test Connections

```bash
python -m cli test-connection
```

### Example Commands

```bash
python -m cli example
```

## ğŸ“ Sample Commands

### List Backups
```
backup> list backups for customer_db
backup> list backups for all databases  
backup> show me available restore points for hr_db
```

### Trigger Backups
```
backup> trigger full backup for customer_db
backup> start incremental backup for hr_db on pg1
backup> backup all databases now
```

### Enable Schedules
```
backup> enable incremental every 2 minutes and weekly full backups
backup> enable schedules on both servers
backup> setup automatic backups
```

### Restore Operations

#### Latest Restore
```
backup> restore customer_db to latest
backup> restore all databases to the latest safe point
```

#### Timestamp-based Restore
```
backup> restore customer_db to 2025-09-10T10:30:00Z
backup> restore hr_db and inventory_db to around 2025-09-10 10:30 UTC
backup> restore everything to 2025-09-12T14:45Z
```

## ğŸ”§ Configuration Options

### CLI Overrides

```bash
# Override MCP URLs
python -m cli run --mcp1-base-url http://other-host:8001 --mcp2-base-url http://other-host:8002

# Non-interactive mode (future)
python -m cli run --no-interactive
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `MCP1_BASE_URL` | MCP1 server URL | Required |
| `MCP1_API_KEY` | MCP1 API key | Optional |
| `MCP2_BASE_URL` | MCP2 server URL | Required |
| `MCP2_API_KEY` | MCP2 API key | Optional |
| `OLLAMA_BASE_URL` | Ollama server URL | `http://localhost:11434` |
| `OLLAMA_MODEL` | Ollama model name | `llama3.1:8b-instruct` |
| `OLLAMA_TEMPERATURE` | LLM temperature | `0.2` |
| `OLLAMA_NUM_CTX` | Context window size | `8192` |

## ğŸ§  How It Works

### Supervisor Agent Workflow

1. **Intent Detection**: Analyzes user input using Ollama to determine operation type
2. **Server Routing**: Decides which servers/agents to engage based on context
3. **Restore Planning**: For restore operations, gathers backup data and suggests optimal restore points
4. **Execution Coordination**: Hands off to appropriate backup agents
5. **Result Aggregation**: Collects and formats results from all operations

### Restore Planning Logic

For restore operations:

1. **Data Collection**: Gathers backup lists from relevant databases on both servers
2. **Selection Strategy**:
   - **No timestamp**: Selects latest backup per database
   - **With timestamp**: Finds backup with smallest time difference per database
3. **Plan Generation**: Creates restore plan showing selected backups and reasoning
4. **User Confirmation**: Displays plan and asks for confirmation
5. **Execution**: Dispatches restore operations to appropriate agents

### Backup Agent Behavior

Each backup agent:
- Communicates only with its assigned MCP server
- Wraps MCP tools as LangChain Tools
- Uses Ollama for natural language processing
- Returns structured JSON responses
- Never performs direct database operations

## ğŸ—ï¸ Project Structure

```
sp-lakehouse-backup/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ backup_agent_pg1.py      # PG1 backup agent
â”‚   â””â”€â”€ backup_agent_pg2.py      # PG2 backup agent
â”œâ”€â”€ supervisor/
â”‚   â”œâ”€â”€ system_prompt.txt        # Supervisor agent prompt
â”‚   â””â”€â”€ restore_planner.py       # Backup selection logic
â”œâ”€â”€ tools/
â”‚   â””â”€â”€ mcp_tools.py            # LangChain MCP tool wrappers
â”œâ”€â”€ llm/
â”‚   â””â”€â”€ ollama.py               # Ollama LLM helpers
â”œâ”€â”€ mcp_client.py               # MCP REST client
â”œâ”€â”€ graph.py                    # LangGraph workflow
â”œâ”€â”€ cli.py                      # Interactive CLI
â”œâ”€â”€ pyproject.toml              # Project dependencies
â”œâ”€â”€ env.example                 # Environment template
â””â”€â”€ README.md                   # This file
```

## ğŸš¨ Important Notes

### Constraints

- **No Local Backup Code**: All backup/restore operations must go through MCP REST APIs
- **DB-Level Operations Only**: Always requires `db_name` parameter, no cluster-level operations
- **MCP Owns Scheduling**: Backup schedules are managed by MCP servers (2-min incremental, weekly full)
- **Read-Only Local Operations**: This orchestrator only coordinates, never directly touches PostgreSQL

### Error Handling

- HTTP retries with exponential backoff for MCP communication
- Graceful degradation when individual servers are unavailable  
- Detailed error reporting with server context
- Validation of MCP responses and tool availability

### Security

- API key authentication for MCP servers
- No storage of sensitive data in orchestrator
- All database credentials managed by MCP servers
- Optional TLS support via MCP server configuration

## ğŸ§ª Development & Testing

### Run Individual Components

```bash
# Test MCP client
python mcp_client.py

# Test Ollama connection
python llm/ollama.py

# Test backup agents
python agents/backup_agent_pg1.py
python agents/backup_agent_pg2.py

# Test restore planner
python supervisor/restore_planner.py

# Test full graph
python graph.py
```

### Add New Tools

1. Add tool to MCP server implementation
2. Create LangChain wrapper in `tools/mcp_tools.py`
3. Add to agent toolsets in `tools/mcp_tools.py`
4. Update supervisor logic in `graph.py` if needed

## ğŸ¤ Contributing

1. Follow the existing code structure and patterns
2. All backup/restore operations must go through MCP REST APIs
3. Maintain separation between supervisor and backup agent responsibilities
4. Add comprehensive error handling and logging
5. Update tests and documentation for new features

## âš ï¸ Limitations

- **MCP Server Dependency**: Requires properly implemented MCP servers
- **Single Ollama Model**: Uses one Ollama model for all agents
- **No Persistence**: Conversation history lost between CLI sessions
- **Limited DB Discovery**: Database names must be known or specified
- **No Multi-Tenancy**: Single orchestrator instance per environment

## ğŸ“ Support

For issues related to:
- **Orchestrator Logic**: Check logs and validate environment configuration
- **MCP Communication**: Verify MCP server availability and API compatibility  
- **Ollama Issues**: Ensure model is pulled and service is running
- **LangChain/LangGraph**: Update to latest compatible versions

The orchestrator provides detailed logging to help diagnose issues across the multi-server setup.
